<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHL Candidate Importer</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #7dc9fc;
            color: black;
            text-align: center;
            padding: 20px 0;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        input[type="file"] {
            margin-bottom: 0px;
        }

        input[type="password"] {
            width: 190px;
            margin: 10px 0;
            padding: 10px;
            font-size: 14px;
            margin-bottom: 30px;
        }

        button {
            padding: 10px 20px;
            background-color: #001e47;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #185ba8;
        }

        footer {
            background-color: #f0f0f0;
            text-align: center;
            padding: 10px 0;
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            box-shadow: 0 0 10px rgba(0, 120, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #d0e7ff;
        }

        th {
            background-color: #001e47;
            color: white;
        }

        tr:hover {
            background-color: #e6f2ff;
        }

        #loading {
            display: none;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPwAAABkCAMAAACVQK17AAABSlBMVEVHcEwfZ60AAAACAgIbGxwAAAAAAAAySmQjRmkBAQFBQUMcabJVVlgZXakAAAAcaLIAAAAaZbABAQEaZrAAAAAAAAAAAAAAAAAAAAAnisoZXqoDAwMbYaxfYGIjlNEbaLEAAAAZX6saYq0ZYaxtbnACAgIAAABqa20AAABZWlwYXKkbaLEdZK8CAgJNTU8ZXKlUVVdJSUtSUlRUVVcji8oYbbUcZ7Eeg8RNTU9lZmgcZ7FISEpSUlRZWVtKSkwZer4jisokiclHSEkA//8YZ7QAAAAYW6gdZ7EXbLQVbrZMTE4UcbgTdLoaarMeZK8aX6tVVlhZWlwUd7wWeb5QUFJISEpeX2FSU1UbfsEegMMYe78ig8VkZWcljcwmhsccYq1oaWs5OTptbnDq8vYqKiyOv9/R5fAUFBU7i8ZnrtlUms0soNm51+pHcEznxjCWAAAAbnRSTlMADSUwDT0ZBgL2/hiU9mw4+1rYJpXlvqrs+8BHq2f+SeCVz36ZYcv9Uh7qbOp/lt0wVXdF2LvzoerJ3s/F5arthL7yR///////////////////////////////////////////////////////AJiQkpIAABGnSURBVHja3JxrV9raFoZJy26iMTum2d0dUJAG7PFwqdwERcXbGIo3QC3iBRWtlSL6/z+fdc9cId3d5xvw0taOkGqevHPONddaoYHAv5ViWk44mzKMPSbDSEWUwORL02NOOLXnVSqhTj655cQNL7iRjSRik268EvMh38s6MXviQ163IsPRboTTthTvqqLouqJOGnrY8EG3dCkpzLQTjsfj4UjanJxg0NNho+nKFx0nRblWr9fwq5YpJSYjGdQYRu8ycf5sAqKrZiRTh6rVViMTUAX1RIZQN6joHTAipgZtT2P0fSDMX45YyrjbLriFuhnJ9oDulDH5ARDhr5VLUmqMn+2YtiapEY9J9VyP1An5ERDhx/jhcXVfsyOcHGZz2JTOskv1fUp+LCTwayj4Y+M49GmxeIODg2yO2B52io6Zz5goP8bHNysjF4jxSHdrtUHR992E3t+P6H7sjPwbEePH+Ji+0VhN6+PGniHoApymcsn2Zyfk10yEH9Ib42W+ms5Q9ANYyo592Ck6Jr8UovwIn9F3u9n0+BQ+zRLssJTF5VqnRwQ7Rr8SIviCHg0QuDWwxwU+torY991SRmvZpqXJ4zs+Ab2HbCfoHSaKD+hRb9Dci49J6JtxwX4MatmWFLpqorxP2ZHthPyOifBTepT3NPBRT5wdizHfDlP2I1HKcC27LOlyZpRJ0J+dMfY7IA89CXw0GUqMPr3icPZjXstwMduMydGxyoMesVP0WyaCT+lx4ONmh1g/DvRWWbCLMo7SeFmVZu+4sePsVx2AfhtaWtre3l7GKpVK8dVMnWU9XuwbcXo7juu8t4x3lkw54WvEeBT0kH0utLS8FbN1RVE1LFVVdN20Ek48Q+CR9yPd7KoOYT8Q7KyMb0nGxzL0/tCgp+xzoe0tU+clXSrtqm6mI1m8GpSyRnqUy9ToTIWwX/I6LhuPo2OfG4/fxsG+9c+rV5ptOVnDSIyy8RE36Dk7MjYkZbyKSyKJemZ8KLRt6b8fxlU9NtLrOyYznrOzOh4yh6PDjfrQ9r9jQlVgpPvaNDf+DI5hoSVptTLSqPFaj09ZSo/xgg3kKkHj3Tq+pUljoYBH52wu29pEsGv6Kg/oMxL0vI7DqNfDDQaPb9CSNTGL9LFyHTQvtI4j+G0F9rUGgN82tUlhxynPmhc4gM8ta9D4poDfXNYDkyMHlvGrDmOfg51JzGh2Gfwm6lYnxngyyoMxTMDb8JQmh99MT9QGrRKuwZTn7HCgM1McfsLYA3p8GP527gW0d1pib4/Cl9OTthe9CroX1/kteHsofK2cmLSHEmxf+Jc0aHAMAt+oORP3QMYvnAdrOA6aluKkL+mBiYOP+xY8E1REvCTR7K6aE8fOWnsv/JINaj2Bz1ja5MGrjgee0LsjnWaRZ1KazkQ+gZXwa3JceNUh8GGfhNei8z7KeSILnhQdoaFSUxAS6O3ppC4E4TUlTlYh/dbhtOh3H81L6ZGc/74gNJ8cqUUcGy/k+MzqXOftLIbHQa/qNpIC2JIVH/gKJMxVFu7vMfc9es2P1LRAtWxR7o+ktQy34MXwAmzWVvFabCqVyoYdd+lOBdYvUIfvv3+PCkKtWLkXWoiOVnuoOzqf2cg7MWABL02W3k0nyx5OazaNsFjDSlYWODXX/YKwXs0L9pubyoixB8wwLuGWu4bH1y9DIQs09nvZSIq0eOThJLz5HI4RdzVtfoGYiqFdRek/Dc7f3yBqovtKbtRGygSBt/k6Fly93YL9nUHQ6dMqdAsya1EfcxCaWnx/Q61PzhNyil/JjdoqgBIm8O66/RlLe0TPZ3VKZI/P6fhzKngTspmiPY86T4CBMD6yXstVwMH/u8yrv5cW0IYP/ea7gBPsbJwkb7pcA7tVdNeCl3vc3GJ2Fhr0qSO8BZuNMesxL30JVRRU6tDX9k0b66YQlEa/YvSXKtJWKlmY+a2Kgbz3kKesBNF3WaQvphycrmVtsn4r71MS+k3Tnc92G3ztkjx5g7egkfe07QnO33iEiG+K0WqbcrdvbqrSNanRShvqVFJ7hlxfcl0cOaEvry6quUB+5QKoddGaka1XZ1pEh4eHLfQ6bO0UQcrvGQRRTdTgDjXdpU0L+Cb2nQ2EZAv+GHvfNdLkRxUZr6DBf6+SA/RYtahJ7FUPr6ST0/UkGSOrJ78QZ11UA+oipea6yHvCPrl+SNSiXw7XQPahdLb4nJ5vVdL9eUTPkh7Bdwk7a/w7navLb2eIHgU+CZtghRODe+DeiranzBerxGA/bixEX9DIKHkq8Z5seEMcRYiWXG9BrXkri1pcOYTaAJeCercEHbISDbZJzR5KQfG9SdscPdts1A+Ozq75Ctcdpj8+2q91mzQ4ojdtP53iX6dtVPkl4zck3mqBSIrqdVIglHUY0ijIvbULf1ttkQY1ZxvqJJIY/pxrB0YGmquGFdf6OniyEplvsQltt9Yf3D0/PQ1uB0/oz/7z4Or67Ohq0G86mms9gAa+tmdkM7RklXtMfF5U6UHhMXK5SgdKAU9MXQ/6jQnJNZbOLRLahaETijsYmuPvwDmXgfvWALee0/MHS5fJfUkb3drT42uv9/j41EN/9p57vT6y/vlx0KV3Tou226f+eVwteK85L5cuernFE2gyDd7cihTRBd8uQY7qldzQCQXh+vn0+fQavBo8Y7H4nkwDPIJInsOjce+gqEfwyHBE//Ly+vj89Ph8dX35+lrvsjtHS7MPfnWoo1VnoMcn7HJngMWtkw1yiVFex0jBWin6dgMFGNTnQymPkgxBu5LSAsPzD0bGMoKe4+OU1iIEfnDZ6fd6Ly8vz49P6FfnevD4hOo9Gw4LUrl2k7c4ZFdQzmQazOqGbDI9Jgxtecq0zOYG9fmiNpwWLvnDw7Q0GJBPyTEANYH3IgH+0XGJzHoIfB/Av7yiuEf3Q8CDnAU6Xffp5nMr0thEUj6QWxMWi7EYZXPrF2XaLSDBNSmqh1M+j5Af8G+i6ZwXnlYtEvhdSs8ePT44OrCE8xB+DsV9v/d6VOumTBHMp8NjsV+a5i8kk6kV+ZawuMVNLu7QYwyt4Bv1qJyBoN4ZSg1t8QFKSnkKH+czdzNLJ278cfv9A2y9w+CvEO/LHIa/HfReB4/PaKzL8n+aq8L2Q4ppOU4XXYsRKE95aSwm0aAWODb56lPKSLpNw6heG/p5wbWHHw8/mH7++Cq5gTcjmg3+mJxmZbps3so+aVFP4xYYV/v+NYLvzc3NYfjQK6r+fdTlhBUBBdtMJp8iRYYmbjEfl4PrwOLzwzw9dg40veY70AU3mKU/CONwyr/9MDU19XN3amoXa+qT9GaKzFkyfN1CRcNaF37EZh9FhZ0i8N8uEfztLYa/6+DCj1q8piPiyzMwUQ33HDyYucmsDpyDukVNxsem3Zhe9F0HefP+J9LUT8I2O/XfoRO+UGqm9++kN9kenNiJURyj2XX5kRxFiTRrT73+8be73uvt3S0u9SgIHgco6sGiZtAt2GDc9VqvFaDHzORAfgd4zIajLyJaf2DAr59k/UFO+iSxfX4zlPIf4fu7H+U76LANSPF8KKZvio8TIvhyWkVx3x8cH51dDgadTqf/3L+8vnrtXdf5tA7/FDW/BkYmHtWHXsNYMIuhh2ZyLi/0Kf/pLYnBj7uz7lXPIlslffiTNIZ/yWzDKf8f+P7sn/K7FlumKIvNGEJPF+voDcjEkPVkNs/mupeX12dokK9D44OFFZcYe0vdnd556xenSLsYYfdvn0ymT+29e7/7D/r8hdaKv6WjXwPDKQ/f/+C5GDPF1mgyMUGfQMc4P1bcxKNAjc7nsY6fUZvbR/N58f9GvFucpmOpG6dUU39J1mtfZuXLJT80+AbqHTn2hxTQs5/f/6+ba+ltGwfCjihRFAzRsiyJ2siAZRsiBCdCLm0C5NL20HYXaB1gc0l3geba/v8/sKReFsmxnLTIYcODDxIt6SPnPZwZjiRrnDGUDielmcnyyuu4rYexugDVbY/eXZ3XSdl+bOZbv0b/V1t381PY9zKW0eo5gph3dI+U1XZVOm2kL6ni4aiJl1DtKXg4bAJh08SZ+TqmC83tp/6szby/t1jvtO4Ya7+e1dg+f3798WP/eNcVHpFshEQDOlA/RCXmoPlcnXjlH2xVUmns0T1SxRYZCkF9nUeN0PVOOWV12HxfbRlwXp/Gkrbv16Zs7K4rMHWLfIw9+XA/VGJut0JlzIYaNJavQI8OK6sWFMYER2ULZIZve/B/3/dHSok73aq9Mny/Pp2wb8L2j3e7desJ21U6hl18EznG8q30pQDxlp65IKY4U7E5xoRKeXJisMXkQlh4n2tp9uX+nzeHo1ZEtk7Qm0Z0bRR261lLY3jI7p43vvUaMaedUjOoQdNhJjcDq8ZNlk9Okc/iarD1D99uDuXPBGiV4l+di0u7TjwQlBw+IPCqCADvFUd4sMVk5QY1EFU/m5JqAqxaZGBTnwzYfxOy9R8HJ4q/vbsZlE6Q6Wq73Fztdr5MUG7Ot6vFaul/6k4puNnwI2Nqq+xrSKvSA4wSVQ401KASdFCBG4/5CZYvg3H7T279pgXfHU54p9RPkLPpdDETYyEriFbLy7tPnRdo0yFWnrm6btH1r3a3lgYuNVeKqAQNcPOTbNtT9l+TuOi3vq6a+v5dVs6Y9SPuYr68Fiquqxayq+HbE0QM+arpIE2nNZggRacRNAdZnlRj2tCwbT9SUGNMl+rWN0naD+9X08MpBPdsMV/fXtc1kg3RExwNsAfMIgAfKjqG4BzApDJmsyAqQQPcfGzVVJaPn6Ax6hjGAP1DWyH7x5sPN+/nq9lqfnHzdnPbFYg2zgxxBqLuoxdhmK2VrdcwMUtaawqFB81MjX4o+NW6oETqsFz1U9JSn9B78fvPhwNZfVHdv99kafS7uj70S5Oa7ew6txwK7pTafVAtGbFxqaq9czlSQBWrBB0kkTqat6mu+sdUHXFkqywfaBPCbknPll0CustTPnQl8XVN/JdDZfCuzsy6iqjLS/eo66LQpB15owYRR5A5oFtNjXQh0egkhsFtAPZrsmgLaNoMfd8QQWmGUGOvNTyu0uAweEYUmzMwhteJLLtkeXxs8KqRG8Lv9Y6PtOUwm52YhPKRCU08oGP72/0wUdnUj98rbTAk9ssaO0EFPYzCUkQNcag5il5eq+4r4MvKOc7IQO2OuWhsln3qKe4wgDCvMxZd+bzR/6XD/grPnzaBWzVXN+z80xzD2W9WrxO78OMuLvft5g+bPnUtnwT2/0/zj184jtii19p9ddC1vmCvDv1cTdj0bd4E9Ovl7JW3OiWrzTBh07YEk9Dfzl99v09CZktfyVhI5PvL5bEGd3at+GwCZE/lIIZcqS/brnnkTv7I+dDDxEULu6CcOsQy1e+qn/RsUj2bL3ePg06A15fL7dHWCJhJgwMz0+O0koQxpjtjdsSYvGG4GIWcWjBh3znM9OBwlSRJhAjwfnnDAq47wgZl6PmbfzZbn19d+75/ebtZrudjLT1x6Ak/EYdGiISguBCug3EoA6EsrxAy8GWx+FoWUOGmAlkXxjMrSxILcG2oVXIzzGPlJclC6v4K7U/OFrPVajZbTE/8HYcJtyDwwrRE8EFbHBbADXGVYJ5Hwi0ygzZFLCkFhYDPmmdiubgNgEc8sn9HAJyegkOaRDYE3skdwdoEBg+55pGb8SjBlvksN2qCOxEEMhOslADXKWP4hQWkgF3GhQXtfMoFN9pPBU8oxxVzQlRwy4zUNbEMaoZwrTyqmOpWtde5R8nLgxcM6YA8X5Wl4z4V/CQLUUIxLyKTgXFSgycgeBaFwBZbcRKF6OXBS17kMM9PjvE8GIilHLlCF1AgQF3TtQuSd0ayvAAEYYGT3+L5J4InRZ4DO/9M8C7jAhuNof0q45JMJEhQ4NkMlvZOWJAXBy+EFZANEGRfFCV+MvgJlblsJ4Xy9XYU0qzgQORZgp/A0l5QygsTPk6kEipDMy6KwjjPobfjBAZfCw6cgAlJXOVpHgEraXFhXmWmAWDxTP5UJzT1fwBamChFM7xHAAAAAElFTkSuQmCC">
        <h1>GHL Candidate Importer</h1>
    </header>

    <main>
        <input type="file" id="fileInput" accept=".pdf,.xlsx,.xls">

        <input type="password" id="ghlToken" placeholder="GHL access code">
        <button onclick="importCandidates()">Import candidates</button>
        <div id="loading">Loading...</div>
        <br>
        <table id="output" style="display: none;">
            <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Result</th>
            </tr>
        </table>
    </main>

    <footer>
        <p>&copy; 2025 My Xcell Network</p>
    </footer>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF.js -->
    <script type="module">
        import * as pdfjsLib from 'https://mozilla.github.io/pdf.js/build/pdf.mjs';

        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://mozilla.github.io/pdf.js/build/pdf.worker.mjs';
    </script>

    <script>
        // todo set parameters
        locationId = 'WjAa77ktYMi8ZAdVtm0T';
        daysTreshold = 180;
        tag = 'imported_from_computrabajo';

        /**
         * Function: importCandidates
         * -----------------------------
         * Formats the PDF report uploaded, calls GHL's API to create missing contacts.
         * and tags all new contacts and contact with an update date older than 6 months.
         * 
         */
        async function importCandidates() {
            const fileInput = document.getElementById('fileInput');
            const passwordInput = document.getElementById('ghlToken');

            if (!fileInput.files.length) {
                alert('Please select a PDF file.');
                return;
            }
            if (!passwordInput.value || passwordInput.value == '') {
                alert('Please fill in the GHL access code.');
                return;
            }

            const ghlToken = passwordInput.value;
            const file = fileInput.files[0];
            const reader = new FileReader();

            // prepares the processing function to be called when the file is read
            reader.onload = async function (event) {
                const fileName = file.name.toLowerCase();

                let candidateData = {};

                if (fileName.endsWith('.pdf')) {
                    const typedArray = new Uint8Array(event.target.result);

                    // read PDF as buffer
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;
                    let pdfText = ``;

                    // read every page as text and concat
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' '); // Join text items with space
                        pdfText += pageText + '\n';
                    }

                    candidateData = formatCandidateData(pdfText);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    candidateData = {};
                    for (const row of jsonData) {
                        if (!row.phone || !row.name) continue;
                        const phone = String(row.phone);
                        candidateData[phone] = {
                            name: normalizeName(row.name)
                        };
                    }
                } else {
                    alert('Unsupported file type.');
                    return;
                }

                await importToGhl(candidateData, ghlToken);
            };

            reader.readAsArrayBuffer(file); // Read the selected file
        }

        /**
         * Function: formatCandidateData
         * -----------------------------
         * Based on the computrabajo report, captures both the name and phone number of 
         * all candidates.
         * 
         * Parameters:
         * pdfText: the PDF file parsed as a string.
         */
        function formatCandidateData(pdfText) {
            const candidates = {};
            const candidateRegex = /Hoja de vida de\s+([A-ZÁÉÍÓÚÑa-záéíóúñ .'-]+)[\s\S]+?(\+?57[-\s]?3\d{2}[-\s]?\d{3}[-\s]?\d{4})/g;

            let match;
            while ((match = candidateRegex.exec(pdfText)) !== null) {
                const name = normalizeName(match[1]);
                const phone = '+57' + match[2].replace(/[^0-9]/g, '').slice(-10);
                candidates[phone] = { name };
            }

            return candidates;
        }

        /**
         * Function: normalizeName
         * -----------------------------
         * Removes extra spaces, trims and capitalizes all names.
         * 
         * Parameters:
         * str: a name.
         */
        function normalizeName(str) {
            // remove all double spaces
            str = str.replace(/\s\s+/g, ' ');
            str = str.trim()

            // Split the string into an array of words
            const words = str.split(' ');

            // Capitalize the first letter of each word
            const capitalizedWords = words.map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());

            // Join the words back into a string
            return capitalizedWords.join(' ');
        }

        /**
         * Function: importToGhl
         * -----------------------------
         * Main functions that calls all GHL web services.
         * 
         * Parameters:
         * formattedCandidateData
         * ghlToken: token to authorize requests
         */
        async function importToGhl(formattedCandidateData, ghlToken) {
            const results = [];

            // test data
            // formattedCandidateData = {
            //     '+573157100964': {
            //         name: 'Juan Felipe Estupiñan Soto'
            //     },
            //     '+573217205089': {
            //         name: 'Natalia Vargas Duarte'
            //     }
            // }

            // First, search for candidates to see which ones already exist
            const phoneNumbers = Object.keys(formattedCandidateData);
            const existingCandidates = await searchCandidates(phoneNumbers, ghlToken);

            // Update map of contacts with existing candidates' ids
            for (let candidate of existingCandidates.contacts) {
                console.log('Processing', candidate.phone);
                const differenceInDays = Math.floor((new Date() - new Date(candidate.dateUpdated)) / (1000 * 60 * 60 * 24));
                console.log(candidate.dateUpdated);
                console.log(differenceInDays);
                if (differenceInDays < daysTreshold) {
                    // If candidate was updated in the past 6 months, do not contact
                    console.log('too recent, removing');
                    results.push({
                        name: formattedCandidateData[candidate.phone]['name'],
                        phone: candidate.phone,
                        result: 'Applied less than 6 months ago. Ignored.'
                    })
                    delete formattedCandidateData[candidate.phone];
                    continue;
                }
                formattedCandidateData[candidate.phone]['id'] = candidate.id;
            }

            // Iterate formattedData and create or update accordingly
            for (const key in formattedCandidateData) {
                const candidateRecord = formattedCandidateData[key];
                let resultMsg;

                if (candidateRecord.id) {
                    resultMsg = 'Updated existing candidate.';
                    await updateCandidate(candidateRecord.id, ghlToken);
                } else {
                    resultMsg = 'Created new candidate.';
                    await createCandidate(candidateRecord.name, key, ghlToken)
                }
                results.push({
                    name: candidateRecord.name,
                    phone: key,
                    result: resultMsg
                })
            }

            // populate results table
            const resultsTable = document.getElementById('output');
            for (const candidateResult of results) {
                console.log(candidateResult);
                const newRow = resultsTable.insertRow();
                const nameCell = newRow.insertCell()
                const phoneCell = newRow.insertCell()
                const resultCell = newRow.insertCell()

                nameCell.textContent = candidateResult.name;
                phoneCell.textContent = candidateResult.phone;
                resultCell.textContent = candidateResult.result;
                document.getElementById('output').style = 'display: block';
            }

        }

        /**
         * Function: searchCandidates
         * -----------------------------
         * Finds all existing GHL contacts that have a phone number from a list.
         * 
         * Parameters:
         * phoneNumbers: the list of numbers to search.
         * ghlToken: token to authorize requests
         */
        async function searchCandidates(phoneNumbers, ghlToken) {
            // prepare filters
            const phoneFilters = [];
            for (const phoneNumber of phoneNumbers) {
                phoneFilters.push({
                    field: 'phone',
                    operator: 'eq',
                    value: phoneNumber
                })
            }
            const filters = [
                {
                    group: 'OR',
                    filters: phoneFilters
                }
            ]
            // prepare request
            const reqBody = {
                filters,
                pageLimit: phoneNumbers.length * 2,
                locationId
            }
            // make request
            try {
                const response = await fetch('https://services.leadconnectorhq.com/contacts/search', {
                    method: 'POST',
                    body: JSON.stringify(reqBody),
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${ghlToken}`,
                        'Content-Type': 'application/json',
                        'Version': '2021-07-28'
                    }
                });
                // return response
                const candidates = await response.json();
                
                if (candidates.statusCode && candidates.statusCode == 401) {
                    throw new Error('Invalid GHL access code');
                }

                return await candidates;
            } catch (error) {
                alert(error);
                throw new Error('searchCandidates failed:', error);
            }
        }

        /**
         * Function: createCandidate
         * -----------------------------
         * Creates a new GHL contact with the tag 'imported_from_computrabajo'.
         * 
         * Parameters:
         * name
         * phone
         * ghlToken: token to authorize requests
         */
        async function createCandidate(name, phone, ghlToken) {
            const names = name.split(' ');
            // prepare request
            const reqBody = {
                firstName: names[0],
                lastName: names.slice(1).join(' '),
                tags: [
                    tag
                ],
                phone,
                locationId
            }
            // console.log('creating', phone);
            // console.log(reqBody);
            // return;
            // make request
            try {
                const response = await fetch('https://services.leadconnectorhq.com/contacts/', {
                    method: 'POST',
                    body: JSON.stringify(reqBody),
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${ghlToken}`,
                        'Content-Type': 'application/json',
                        'Version': '2021-07-28'
                    }
                });
                // return response
                const candidate = await response.json();

                if (candidate.statusCode && candidate.statusCode == 401) {
                    throw new Error('Invalid GHL access code');
                }

                return await candidate;
            } catch (error) {
                alert(error);
                throw new Error('createCandidate failed:', error);
            }
        }

        /**
         * Function: updateCandidate
         * -----------------------------
         * Updates a candidate with the tag 'imported_from_computrabajo'.
         * 
         * Parameters:
         * id: id of the existing contact
         * ghlToken: token to authorize requests
         */
        async function updateCandidate(id, ghlToken) {
            // prepare request
            const reqBody = {
                tags: [
                    tag
                ]
            }
            // console.log('updating', id);
            // console.log(reqBody);
            // return
            // make request
            try {
                const addResponse = await fetch(`https://services.leadconnectorhq.com/contacts/${id}/tags`, {
                    method: 'POST',
                    body: JSON.stringify(reqBody),
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${ghlToken}`,
                        'Content-Type': 'application/json',
                        'Version': '2021-07-28'
                    }
                });
                // return response
                const updatedCandidate = await addResponse.json();

                if (updatedCandidate.statusCode && updatedCandidate.statusCode == 401) {
                    throw new Error('Invalid GHL access code');
                }

                return await updatedCandidate;
            } catch (error) {
                alert(error);
                throw new Error('updateCandidate failed:', error);
            }
        }
    </script>
</body>

</html>